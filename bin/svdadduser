#!/bin/sh

CONF_FILE="/etc/sofin.conf.sh"
if [ -e "${CONF_FILE}" ]; then
    . "${CONF_FILE}"
    validate_env
else
    echo "FATAL: No configuration file found: ${CONF_FILE}"
    exit 1
fi

USER_NAME="$1"
if [ "${USER_NAME}" = "" ]; then
    note "New user name not specified!"
    exit 1
fi

if [ "$(uname)" != "FreeBSD" ]; then
    error "Only FreeBSD hosts are supported."
    exit 1
fi

if [ "$(id -u)" != "0" ]; then
    error "This command requires superuser privileges!"
    exit 1
fi

if [ -d "/Users/${USER_NAME}" ]; then
    error "User ${USER_NAME} already exists."
    exit 1
fi

note "Creating ZFS datasets"
zfs create -o casesensitivity=sensitive -o mountpoint=/Users/${USER_NAME} zroot/Users/${USER_NAME}
zfs create -o casesensitivity=sensitive -o mountpoint=/Users/${USER_NAME}/Igniters zroot/Users/${USER_NAME}/Igniters
zfs create -o casesensitivity=sensitive -o mountpoint=/Users/${USER_NAME}/SoftwareData zroot/Users/${USER_NAME}/SoftwareData

note "Adding user: ${USER_NAME}"
pw useradd "${USER_NAME}" -n "${USER_NAME}" -d "/Users/${USER_NAME}" -m -s /Software/Zsh/exports/zsh >/dev/null|| error "Failed to add user!"

note "Allowing snapshot,send,receive to ZFS datasets"
zfs allow ${USER_NAME} snapshot,send,receive zroot/Users/${USER_NAME}

mkdir -p "/Users/${USER_NAME}/.ssh"

note "Paste user ssh key below (ctrl-d after new line to end)"
cat > "/Users/${USER_NAME}/.ssh/authorized_keys"
touch "/Users/${USER_NAME}/.autostart"
chown -R "${USER_NAME}" "/Users/${USER_NAME}"
su - ${USER_NAME} -c "sofin reload && ignitersinstall"

note "User added: ${USER_NAME}"
