#!/bin/sh

bin/clean
mkdir -p releases

version="$(grep -R 'APP_VERSION' src/globals/globals.h | awk '{ gsub("\"", "", $4); print $4}')"
base_name="thess-${version}"
archive_name="${base_name}.tar.bz2"
printf "Preparing package: ${archive_name} with version: ${version}\n"

tar --disable-copyfile --exclude='.git' --exclude='.gitignore' --exclude='releases' -cjf releases/${archive_name} ./
mkdir -p releases/${base_name}
mv releases/${archive_name} releases/${base_name}/
cd releases/${base_name}
tar xf ${archive_name}
rm -f ${archive_name}
cd ..
tar -cjf ${archive_name} ./${base_name}
rm -rf ${base_name}
cd ..

printf "Pushing package to remote server\n"

# XXX: NON DRY: Sofin utility fragment:
readonly default_port="60022"
readonly user_name="sofin"
readonly default_source_path="/Mirror/software/source"
readonly default_host="software.verknowsys.com"

if [ "$(uname)" = "Linux" ]; then
    for mirror in $(host ${default_host} | awk '{print $3}'); do
        printf "Synchronizing releases/${archive_name} with ${mirror}\n"
        scp -P ${default_port} "releases/${archive_name}" "${user_name}@${mirror}:${default_source_path}"
    done
else
    for mirror in $(host ${default_host} | awk '{print $4}'); do
        printf "Synchronizing releases/${archive_name} with ${mirror}\n"
        scp -P ${default_port} "releases/${archive_name}" "${user_name}@${mirror}:${default_source_path}"
    done
fi

ssh sofin@v "sha1sum ${default_source_path}/thess-${version}.tar.bz2"
