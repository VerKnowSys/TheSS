#!/bin/sh
# author: Daniel (dmilith) Dettlaff
# this script reloads configuration for user ttys assigned to user side svdss

. /etc/sofin.conf.sh

set -v

test "$(id -u)" = "0" || error "Updater must be run as root"

TTYS="/etc/ttys"
TIMESTAMP="$(${DATE_BIN} +%d%m%Y-%H%M%S)"
SVD_PREFIX="/Software/Thess/exports/"
SVD_SHELL="${SVD_PREFIX}svdshell"
STAT_BIN="/usr/bin/stat"

if [ ! -f "${TTYS}" ]; then
    printf "# Default TTYs for ServeD system\n \
ttyv1 \"${SVD_PREFIX}svdss\"              xterm on secure \n \
ttyv2 \"${SVD_PREFIX}svdcoreginx_helper\" xterm on secure \n \
\n" > ${TTYS}
fi
${CP_BIN} "${TTYS}" "${TTYS}-${TIMESTAMP}"

cd /Users
for user in *; do
    user_home="/Users/${user}"
    uid="$(${STAT_BIN} -f%u "${user_home}")"
    if [ "$uid" != "0" ]; then
        test -f "${user_home}/.profile" || (svdshell -u${uid} -- sofin reload > /dev/null 2>&1)
        test -f "${user_home}/.zshrc" || (${PRINTF_BIN} "# $(date +%d%m%Y-%H%M%S) - autogenerated default environment:\nexport HISTFILE=${user_home}/.zsh_history\nexport HISTSIZE=8192\nexport SAVEHIST=8192\nignitersinstall\n" > "${user_home}/.zshrc" && ${CHOWN_BIN} ${uid} "${user_home}/.zshrc")
        # XXX: TODO: that ignitersinstall part is currently necessary, to avoid issues:
        #  * no igniters for new users
        #  * no autoupdate of igniters
        #

        if [ -f "${user_home}/.autostart" ]; then
            ${GREP_BIN} -q "${user}(${uid})" ${TTYS} || (
                note "Autostarting enabled for user: ${user}"
                ${PRINTF_BIN} "\n# user: ${user}($uid):\nttyv${uid} \"${SVD_SHELL} -u${uid} -- ${SVD_PREFIX}svdss\" unknown on insecure\n" >> ${TTYS})
            debug "${PRINTF_BIN} \"\n# user: ${user}($uid):\nttyv${uid} \"${SVD_SHELL} -n -u${uid} -- ${SVD_PREFIX}svdss\" unknown on insecure\n\""
        else
            note "Autostarting disabled for user: ${user}"
            ${SED_BIN} -i '' -e "/${uid}/,+1 d" ${TTYS}
        fi
    else
        note "Skipping system user: ${user}"
    fi
done

${DIFF_BIN} ${TTYS} ${TTYS}-${TIMESTAMP} > /dev/null 2>&1
if [ "$?" != "0" ]; then
    note "Reloading ${TTYS} (file changed)"
    kill -HUP 1
    rm -f "${TTYS}-${TIMESTAMP}"
fi
