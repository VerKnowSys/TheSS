#!/bin/sh
# author: Daniel (dmilith) Dettlaff
# this script reloads configuration for user ttys assigned to user side svdss

. /etc/sofin.conf.sh

test "$(id -u)" = "0" || error "Updater must be run as root"

TTYS="/etc/ttys"
SVD_SHELL="/bin/svdshell"
STAT_BIN="/usr/bin/stat"

if [ ! -f "${TTYS}" ]; then
    printf "# Default TTYs for ServeD system\n \
ttyv1 \"/bin/svdss\"              xterm on secure \n \
ttyv2 \"/bin/svdcoreginx_helper\" xterm on secure \n \
\n" > ${TTYS}
fi

cd /Users
for user in *; do
    user_home="/Users/${user}"
    uid="$(${STAT_BIN} -f%u "/Users/${user}")"
    note "Checking user initial environment"
    test -f "${user_home}/.profile" || svdshell -u${uid} -- sofin reload 2> /dev/null
    test -f "${user_home}/.zshrc" || ${PRINTF_BIN} "# $(date +%d%m%Y-%H%M%S) - autogenerated default environment:\nexport HISTFILE=${user_home}/.zsh_history\nexport HISTSIZE=8192\nexport SAVEHIST=8192\n" > "${user_home}/.zshrc"

    if [ -f "${user_home}/.autostart" ]; then
        note "Autostarting enabled for user: ${user}"
        ${GREP_BIN} -q "${uid}" ${TTYS} || ${PRINTF_BIN} "\n# user: ${user}($uid):\nttyv${uid} \"${SVD_SHELL} -u${uid} -- svdss\" xterm on secure" >> ${TTYS}
    fi

    if [ ! -f "${user_home}/.autostart" ]; then
        note "Autostarting disabled for user: ${user}"
        note "Removing user watchers for uid: ${uid}"
        ${SED_BIN} -i'' -e "/${uid}/,+1 d" /etc/ttys
    fi

done

note "Reloading ${TTYS}"
kill -HUP 1
