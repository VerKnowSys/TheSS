#!/bin/sh

readonly BEGIN_TIMER=$(date +%s)
. /etc/sofin.conf.sh
if [ "$(id -u)" = "0" ]; then
    . /etc/profile_sofin
else
    . $HOME/.profile
fi
note "Loaded Sofin environment\n"

build () {
    QMAKE_OPTS=""
    MAKE_OPTS_BUILD="-j12 --silent"
    case "${SYSTEM_NAME}" in
        Darwin)
            QMAKE_OPTS="-spec darwin-g++"
            ;;
    esac

    (qmake ${QMAKE_OPTS} Notifications.pro) || exit 1
    (make ${MAKE_OPTS_BUILD} && note "Successfully built notifications system\n") || exit 1

    case "$1" in
        panel|svdpanel)
            (qmake ${QMAKE_OPTS} Panel.pro) || exit 1
            (make ${MAKE_OPTS_BUILD} && note "Successfully built svdpanel\n") || exit 1
            ;;

        ss|svdss)
            (qmake ${QMAKE_OPTS} TheSS.pro) || exit 1
            (make ${MAKE_OPTS_BUILD} && note "Successfully built ss\n") || exit 1
            ;;

        tests|test)
            (qmake ${QMAKE_OPTS} TestSS.pro) || exit 1
            (make ${MAKE_OPTS_BUILD} && note "Successfully built tests\n") || exit 1
            ;;

        deployer|deploy|depl|d)
            (qmake ${QMAKE_OPTS} WAD.pro) || exit 1
            (make ${MAKE_OPTS_BUILD} && note "Successfully built svddeployer\n") || exit 1
            ;;

        coreginx_helper|cgx|c)
            (qmake ${QMAKE_OPTS} CoreginxHelper.pro) || exit 1
            (make ${MAKE_OPTS_BUILD} && note "Successfully built svdcoreginx_helper\n") || exit 1
            ;;

        *)
            (qmake ${QMAKE_OPTS} TheSS.pro) || exit 1
            (make ${MAKE_OPTS_BUILD} && note "Successfully built ss\n") || exit 1

            (qmake ${QMAKE_OPTS} WAD.pro) || exit 1
            (make ${MAKE_OPTS_BUILD} && note "Successfully built svddeployer\n") || exit 1

            (qmake ${QMAKE_OPTS} Notifications.pro) || exit 1
            (make ${MAKE_OPTS_BUILD} && note "Successfully built notifications system\n") || exit 1

            (qmake ${QMAKE_OPTS} IRCNotify.pro) || exit 1
            (make ${MAKE_OPTS_BUILD} && note "Successfully built svdirc_notify\n") || exit 1

            (qmake ${QMAKE_OPTS} Panel.pro) || exit 1
            (make ${MAKE_OPTS_BUILD} && note "Successfully built svdpanel\n") || exit 1

            (qmake ${QMAKE_OPTS} CoreginxHelper.pro) || exit 1
            (make ${MAKE_OPTS_BUILD} && note "Successfully built svdcoreginx_helper\n") || exit 1

            (qmake ${QMAKE_OPTS} TestSS.pro) || exit 1
            (make ${MAKE_OPTS_BUILD} && note "Successfully built tests\n") || exit 1


            ;;
    esac
}

build "$1"
readonly END_TIMER=$(date +%s)
note "Build completed in $(echo ${END_TIMER} - ${BEGIN_TIMER} | ${BC_BIN}) seconds."
